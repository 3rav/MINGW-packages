# Maintainer (MSYS2): Jonathan Armstrong <jda2158@gmail.com>

pkgname=rkdeveloptool
pkgver=r69.46bb4c0
pkgrel=1
_commit='46bb4c073624226c3f05b37b9ecc50bbcf543f5a'
pkgdesc="rkdeveloptool is a tool from Rockchip to communicate with Rockusb devices"
arch=('any')
url="http://opensource.rock-chips.com/wiki_Rkdeveloptool"
license=('gpl2.0')

makedepends=("${MINGW_PACKAGE_PREFIX}-gcc"
             "${MINGW_PACKAGE_PREFIX}-pkg-config"
             autoconf-wrapper
             automake-wrapper
             git
             make)
depends=(${MINGW_PACKAGE_PREFIX}-'libusb')

# patch has not been excepted upstream yet: https://github.com/rockchip-linux/rkdeveloptool/pull/56
source=("rkdeveloptool"::"git+https://github.com/rockchip-linux/rkdeveloptool.git#commit=$_commit"
         001-fixes-for-windows.patch)
sha256sums=('SKIP'
            '0ddfeedd526299d3616fa9bb7dab37d2da132f26de1e1c3819591fb26e0d8f45')
install=driver-instructions.install

pkgver() {
    cd "$srcdir/rkdeveloptool"
    printf 'r%s.%s' "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

apply_patch_with_msg() {
  for _fname in "$@"
  do
    msg2 "Applying ${_fname}"
    patch -Nbp1 -i "${srcdir}"/${_fname}
  done
}

prepare() {
  cd rkdeveloptool
  apply_patch_with_msg \
  001-fixes-for-windows.patch
}

build() {
  cd "$srcdir/rkdeveloptool"
  
  aclocal
  autoreconf -i
  autoheader
  automake --add-missing
  ./configure
  
  # note: cmakelists included in src appears to be for mac os only
  make
}


package() {
  cd "$srcdir/rkdeveloptool"
  cp rkdeveloptool.exe /usr/bin/
}
