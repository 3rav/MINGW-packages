# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Maintainer: Ray Donnelly <mingw.android@gmail.com>
# Contributor: Saul Ibarra Corretge <saghul@gmail.com>
# Contributor: Frode Solheim <frode@fs-uae.net>

_primary_python="yes"
_pybasever=3.11
_realname=python

if [[ "${_primary_python}" == "yes" ]]; then
  pkgbase="mingw-w64-${_realname}"
  pkgname=("${MINGW_PACKAGE_PREFIX}-${_realname}")
  provides=("${MINGW_PACKAGE_PREFIX}-python3"
            "${MINGW_PACKAGE_PREFIX}-python${_pybasever}")
  conflicts=("${MINGW_PACKAGE_PREFIX}-python3"
             "${MINGW_PACKAGE_PREFIX}-python${_pybasever}"
            "${MINGW_PACKAGE_PREFIX}-python2<2.7.16-7")
  replaces=("${MINGW_PACKAGE_PREFIX}-python3"
            "${MINGW_PACKAGE_PREFIX}-python${_pybasever}")
else
  pkgbase="mingw-w64-${_realname}${_pybasever}"
  pkgname=("${MINGW_PACKAGE_PREFIX}-${_realname}${_pybasever}")
fi
pkgver=${_pybasever}.6
pkgrel=3
pkgdesc="A high-level scripting language (mingw-w64)"
arch=('any')
mingw_arch=('mingw32' 'mingw64' 'ucrt64' 'clang64' 'clang32' 'clangarm64')
license=('spdx:PSF-2.0')
url="https://www.python.org/"
depends=("${MINGW_PACKAGE_PREFIX}-gcc-libs"
         "${MINGW_PACKAGE_PREFIX}-expat"
         "${MINGW_PACKAGE_PREFIX}-bzip2"
         "${MINGW_PACKAGE_PREFIX}-libffi"
         "${MINGW_PACKAGE_PREFIX}-mpdecimal"
         "${MINGW_PACKAGE_PREFIX}-ncurses"
         "${MINGW_PACKAGE_PREFIX}-openssl"
         "${MINGW_PACKAGE_PREFIX}-sqlite3"
         "${MINGW_PACKAGE_PREFIX}-tcl"
         "${MINGW_PACKAGE_PREFIX}-tk"
         "${MINGW_PACKAGE_PREFIX}-zlib"
         "${MINGW_PACKAGE_PREFIX}-xz"
         "${MINGW_PACKAGE_PREFIX}-tzdata")
makedepends=(
  "${MINGW_PACKAGE_PREFIX}-cc"
  "${MINGW_PACKAGE_PREFIX}-autotools"
  "autoconf-archive"
)
#options=('debug' '!strip')
source=("https://www.python.org/ftp/python/${pkgver%rc?}/Python-${pkgver}.tar.xz"
        0001-sysconfig-make-_sysconfigdata.py-relocatable.patch
        0002-build-add-with-nt-threads-and-make-it-default-on-min.patch
        0003-Define-MS_WINDOWS-and-others-when-compiling-with-MIN.patch
        0004-configure-add-MACHDEP-and-platform-on-MINGW.patch
        0005-Add-default-configuration-for-MINGW.patch
        0006-configure-enable-largefile-support-by-default-for-Mi.patch
        0007-Add-PC-to-CPPFLAGS-and-to-SRCDIRS-on-Mingw.patch
        0008-posixmodule.c-Define-necessary-headers-for-compiling.patch
        0009-Build-winreg-by-default-when-compiling-for-MINGW.patch
        0010-pyport.h-Add-support-for-MINGW.patch
        0011-configure-add-options-so-that-shared-build-is-possib.patch
        0012-Add-dynamic-loading-support-for-MINGW.patch
        0013-Ignore-main-program-for-frozen-scripts-on-MINGW.patch
        0014-Add-missing-library-for-multiprocessing-module.patch
        0015-selectmodule-add-support-for-MINGW.patch
        0016-setup.py-add-libraries-to-fix-compile-of-ctypes-on-M.patch
        0017-Detect-winsock2-and-setup-_socket-module-on-MINGW.patch
        0018-Enable-some-windows-specific-modules.patch
        0019-sysconfig-MINGW-build-extensions-with-GCC.patch
        0020-sysconfig-treat-MINGW-builds-as-POSIX-builds.patch
        0021-Add-support-for-stdcall-without-underscore.patch
        0022-Use-replace-instead-rename-to-avoid-failure-on-windo.patch
        0023-Customize-site-for-MINGW.patch
        0024-add-python-config-sh.patch
        0025-setup.py-add-export_symbols-to-fix-compile-of-ctypes.patch
        0026-mingw-prefer-unix-sep-if-MSYSTEM-environment-variabl.patch
        0027-msys-cygwin-semi-native-build-sysconfig.patch
        0028-sysconfig-mingw-sysconfig-like-posix.patch
        0029-cross-dont-add-multiarch-paths-if-cross-compiling.patch
        0030-mingw-use-backslashes-in-compileall-py.patch
        0031-msys-convert_path-fix-and-root-hack.patch
        0032-mingw-pdcurses_ISPAD.patch
        0033-msys-monkeypatch-os-system-via-sh-exe.patch
        0034-msys-replace-slashes-used-in-io-redirection.patch
        0035-remove_path_max.default.patch
        0036-dont-link-with-gettext.patch
        0037-ctypes-python-dll.patch
        0038-gdbm-module-includes.patch
        0039-use-gnu_printf-in-format.patch
        0040-mingw-fix-ssl-dont-use-enum_certificates.patch
        0041-fix-using-dllhandle-and-winver-mingw.patch
        0042-Add-AMD64-to-sys-config-so-msvccompiler-get_build_ve.patch
        0043-MINGW-link-with-additional-library.patch
        0044-install-msilib.patch
        0045-fix-signal-module-build.patch
        0046-build-build-winconsoleio-and-_testconsole.patch
        0047-expose-sem_unlink.patch
        0048-cygpty-isatty.patch
        0049-disable-broken-gdbm-module.patch
        0050-build-link-win-resource-files-and-build-pythonw.patch
        0051-disable-readline.patch
        0052-fix-isselectable.patch
        0053-_xxsubinterpretersmodule.patch
        0054-configure.ac-fix-inet_pton-check.patch
        0055-set-venv-activate-path-unix.patch
        0056-pass-gen-profile-ldflags.patch
        0057-pkg-config-windows-must-link-ext-with-python-lib.patch
        0058-importlib-bootstrap-path-sep.patch
        0059-pathlib-path-sep.patch
        0060-warnings-fixes.patch
        0061-fix-build-testinternalcapi.patch
        0062-extend-MS_WINDOWS-flag.patch
        0063-clang-arm64.patch
        0064-configure.ac-set-MINGW-stack-reserve.patch
        0065-Don-t-use-os.pathsep-to-find-EOF.patch
        0066-Fix-extension-suffix-for-c-extensions-on-mingw.patch
        0067-Change-the-get_platform-method-in-sysconfig.patch
        0068-distutils-compiler-customize-mingw-cygwin-compilers.patch
        0069-distutils-compiler-enable-new-dtags.patch
        0070-distutils-MINGW-build-extensions-with-GCC.patch
        0071-distutils-use-Mingw32CCompiler-as-default-compiler-f.patch
        0072-distutils-find-import-library.patch
        0073-distutils-avoid-circular-dependency-from-time-module.patch
        0074-distutils-generalization-of-posix-build-in-distutils.patch
        0075-distutils-mingw-sysconfig-like-posix.patch
        0076-distutils-get_versions-fixes.patch
        0077-distutils-install-layout-as-posix.patch
        0078-distutils-msys-convert_path-fix-and-root-hack.patch
        0079-distutils-mingw-build-optimized-ext.patch
        0080-distutils-cygwinccompiler-dont-strip-modules-if-pyde.patch
        0081-distutils-get-compilers-from-env-vars.patch
        0082-distutils-add-windmc-to-cygwinccompiler.patch
        0083-distutils-fix-msvc9-import.patch
        0084-distutils-mingw-add-LIBPL-to-library-dirs.patch
        0085-distutils-Change-the-get_platform-method-in-distutil.patch
        0086-build-Fix-ncursesw-include-lookup.patch
        0087-tests-fix-test_bytes.patch
        0088-time-fix-strftime-not-raising-for-invalid-year-value.patch
        0089-ctypes-find_library-c-should-return-None-with-ucrt.patch
        0090-build-Disable-checks-for-dlopen-dlfcn.patch
        0091-Fix-install-location-of-the-import-library.patch
        0092-Set-MSYS2_ARG_CONV_EXCL-for-the-shared-Python-module.patch
        0093-build-Integrate-venvlauncher-build-installation-into.patch
        0094-configure.ac-set-_WIN32_WINNT-version.patch
        0095-configure.ac-don-t-check-for-clock_-functions.patch
        0096-expanduser-normpath-paths-coming-from-env-vars.patch
        0097-CI-test-the-build-and-add-some-mingw-specific-tests.patch
        0098-Prefer-sysconfig.python_build.patch
        0099-Define-PY3_DLLNAME-to-fix-build.patch
        0100-distutils-remove-checks-for-ancient-gcc-binutils.patch
        0101-distutils-split-CC-env-var-before-passing-to-subproc.patch
        0102-_testconsole.c-Fix-casing-path-sep.patch
        0103-Return-consistent-architecture-markers-for-python-on.patch
        0104-distutils-add-back-gcc_version.patch
        0105-fix-mingw-cross-compiling-in-setup.py.patch
        0106-handle-ncursesw-pkg-config-when-cross-compiling.patch
        0107-mingw_smoketests-fix-_UCRT-condition.patch
        0108-Modify-sys.winver-to-match-upstream.patch
        0109-Change-user-site-packages-path-to-include-the-enviro.patch
        0110-configure-Include-a-header-in-the-check-for-_beginth.patch
        0111-configure.ac-Default-to-without-c-locale-coercion-on.patch
        0112-Fix-failing-tests.patch
        0113-distutils-add-build-root-to-libdirs-when-building-un.patch
        0114-Don-t-change-os.sep-with-an-empty-MSYSTEM-env-var-no.patch
        0115-def-VPATH-when-compiling-Python-sysmodule.c.patch
        0116-Make-_Py_CheckPython3-extern.patch
        0117-link-with-bcrypt.patch
        0118-correctly-find-native-python.patch
        0119-Add-extra-flags-for-_bootstrap_python.patch
        0120-posixmodule-undefine-HAVE_OPENDIR.patch
        0121-getpath.py-add-support-for-mingw.patch
        0122-Don-t-build-_posixsubprocess-on-Windows.patch
        0123-_ssl-link-with-ws2_32.patch
        0124-Fix-building-_socket-module.patch
        0125-Always-normalize-path-in-abspath.patch
        0126-Include-winsock.h-when-checking-for-netdb-function.patch
        0127-include-_multiprocessing-semaphore.c-on-win32.patch
        0128-configure-build-mmap-module-on-win32.patch
        0129-venv-creation-fixes.patch
        0130-move-the-shutdown-function-where-winsock.h-is-includ.patch
        0131-configure.ac-set-BUILDEXEEXT-and-EXEEXT.patch
        0132-configure.ac-fix-building-some-test-modules.patch
        0133-Don-t-convert-sysconfig.get_config_var-VPATH-to-an-a.patch
        0134-Always-convert-to-before-passing-though-pathcch-func.patch
        0135-Build-venvlauncher.exe-from-PC-launcher.c.patch
        0136-getpath.py-fix-dirname.patch
        0137-getpath-use-normpath-on-all-generated-paths.patch
        0138-pathconfig-normpath-sys.path-0.patch
        0139-smoketests-add-some-tests-for-sys-site-paths.patch
        0140-Search-DLLs-only-on-paths-added-using-add_dll_direct.patch
        0141-Allow-picking-up-include-lib-dirs-from-CFLAGS-LDFLAG.patch
        0142-Build-and-install-libpython3.dll.patch
        0143-setup.py-don-t-prepend-the-system-library-directorie.patch
        0144-Port-GetPythonImport-to-mingw.patch
        0145-LoadLibraryExW-make-sure-to-only-use-backslashes-for.patch
        0146-Use-shared-instead-of-mdll.patch
        0147-fixup-sysconfig-make-_sysconfigdata.py-relocatable.patch
        0148-mingw_smoketests-add-a-test-to-check-if-sysconfig-re.patch
        0149-Makefile-Add-a-dependency-on-LDLIBRARY-for-the-share.patch)

# Helper macros to help make tasks easier #
apply_patch_with_msg() {
  for _patch in "$@"
  do
    msg2 "Applying ${_patch}"
    patch -Nbp1 -i "${srcdir}/${_patch}"
  done
}

prepare() {
  cd "${srcdir}/Python-${pkgver}"

 apply_patch_with_msg 0001-sysconfig-make-_sysconfigdata.py-relocatable.patch \
  0002-build-add-with-nt-threads-and-make-it-default-on-min.patch \
  0003-Define-MS_WINDOWS-and-others-when-compiling-with-MIN.patch \
  0004-configure-add-MACHDEP-and-platform-on-MINGW.patch \
  0005-Add-default-configuration-for-MINGW.patch \
  0006-configure-enable-largefile-support-by-default-for-Mi.patch \
  0007-Add-PC-to-CPPFLAGS-and-to-SRCDIRS-on-Mingw.patch \
  0008-posixmodule.c-Define-necessary-headers-for-compiling.patch \
  0009-Build-winreg-by-default-when-compiling-for-MINGW.patch \
  0010-pyport.h-Add-support-for-MINGW.patch \
  0011-configure-add-options-so-that-shared-build-is-possib.patch \
  0012-Add-dynamic-loading-support-for-MINGW.patch \
  0013-Ignore-main-program-for-frozen-scripts-on-MINGW.patch \
  0014-Add-missing-library-for-multiprocessing-module.patch \
  0015-selectmodule-add-support-for-MINGW.patch \
  0016-setup.py-add-libraries-to-fix-compile-of-ctypes-on-M.patch \
  0017-Detect-winsock2-and-setup-_socket-module-on-MINGW.patch \
  0018-Enable-some-windows-specific-modules.patch \
  0019-sysconfig-MINGW-build-extensions-with-GCC.patch \
  0020-sysconfig-treat-MINGW-builds-as-POSIX-builds.patch \
  0021-Add-support-for-stdcall-without-underscore.patch \
  0022-Use-replace-instead-rename-to-avoid-failure-on-windo.patch \
  0023-Customize-site-for-MINGW.patch \
  0024-add-python-config-sh.patch \
  0025-setup.py-add-export_symbols-to-fix-compile-of-ctypes.patch \
  0026-mingw-prefer-unix-sep-if-MSYSTEM-environment-variabl.patch \
  0027-msys-cygwin-semi-native-build-sysconfig.patch \
  0028-sysconfig-mingw-sysconfig-like-posix.patch \
  0029-cross-dont-add-multiarch-paths-if-cross-compiling.patch \
  0030-mingw-use-backslashes-in-compileall-py.patch \
  0031-msys-convert_path-fix-and-root-hack.patch \
  0032-mingw-pdcurses_ISPAD.patch \
  0033-msys-monkeypatch-os-system-via-sh-exe.patch \
  0034-msys-replace-slashes-used-in-io-redirection.patch \
  0035-remove_path_max.default.patch \
  0036-dont-link-with-gettext.patch \
  0037-ctypes-python-dll.patch \
  0038-gdbm-module-includes.patch \
  0039-use-gnu_printf-in-format.patch \
  0040-mingw-fix-ssl-dont-use-enum_certificates.patch \
  0041-fix-using-dllhandle-and-winver-mingw.patch \
  0042-Add-AMD64-to-sys-config-so-msvccompiler-get_build_ve.patch \
  0043-MINGW-link-with-additional-library.patch \
  0044-install-msilib.patch \
  0045-fix-signal-module-build.patch \
  0046-build-build-winconsoleio-and-_testconsole.patch \
  0047-expose-sem_unlink.patch \
  0048-cygpty-isatty.patch \
  0049-disable-broken-gdbm-module.patch \
  0050-build-link-win-resource-files-and-build-pythonw.patch \
  0051-disable-readline.patch \
  0052-fix-isselectable.patch \
  0053-_xxsubinterpretersmodule.patch \
  0054-configure.ac-fix-inet_pton-check.patch \
  0055-set-venv-activate-path-unix.patch \
  0056-pass-gen-profile-ldflags.patch \
  0057-pkg-config-windows-must-link-ext-with-python-lib.patch \
  0058-importlib-bootstrap-path-sep.patch \
  0059-pathlib-path-sep.patch \
  0060-warnings-fixes.patch \
  0061-fix-build-testinternalcapi.patch \
  0062-extend-MS_WINDOWS-flag.patch \
  0063-clang-arm64.patch \
  0064-configure.ac-set-MINGW-stack-reserve.patch \
  0065-Don-t-use-os.pathsep-to-find-EOF.patch \
  0066-Fix-extension-suffix-for-c-extensions-on-mingw.patch \
  0067-Change-the-get_platform-method-in-sysconfig.patch \
  0068-distutils-compiler-customize-mingw-cygwin-compilers.patch \
  0069-distutils-compiler-enable-new-dtags.patch \
  0070-distutils-MINGW-build-extensions-with-GCC.patch \
  0071-distutils-use-Mingw32CCompiler-as-default-compiler-f.patch \
  0072-distutils-find-import-library.patch \
  0073-distutils-avoid-circular-dependency-from-time-module.patch \
  0074-distutils-generalization-of-posix-build-in-distutils.patch \
  0075-distutils-mingw-sysconfig-like-posix.patch \
  0076-distutils-get_versions-fixes.patch \
  0077-distutils-install-layout-as-posix.patch \
  0078-distutils-msys-convert_path-fix-and-root-hack.patch \
  0079-distutils-mingw-build-optimized-ext.patch \
  0080-distutils-cygwinccompiler-dont-strip-modules-if-pyde.patch \
  0081-distutils-get-compilers-from-env-vars.patch \
  0082-distutils-add-windmc-to-cygwinccompiler.patch \
  0083-distutils-fix-msvc9-import.patch \
  0084-distutils-mingw-add-LIBPL-to-library-dirs.patch \
  0085-distutils-Change-the-get_platform-method-in-distutil.patch \
  0086-build-Fix-ncursesw-include-lookup.patch \
  0087-tests-fix-test_bytes.patch \
  0088-time-fix-strftime-not-raising-for-invalid-year-value.patch \
  0089-ctypes-find_library-c-should-return-None-with-ucrt.patch \
  0090-build-Disable-checks-for-dlopen-dlfcn.patch \
  0091-Fix-install-location-of-the-import-library.patch \
  0092-Set-MSYS2_ARG_CONV_EXCL-for-the-shared-Python-module.patch \
  0093-build-Integrate-venvlauncher-build-installation-into.patch \
  0094-configure.ac-set-_WIN32_WINNT-version.patch \
  0095-configure.ac-don-t-check-for-clock_-functions.patch \
  0096-expanduser-normpath-paths-coming-from-env-vars.patch \
  0097-CI-test-the-build-and-add-some-mingw-specific-tests.patch \
  0098-Prefer-sysconfig.python_build.patch \
  0099-Define-PY3_DLLNAME-to-fix-build.patch \
  0100-distutils-remove-checks-for-ancient-gcc-binutils.patch \
  0101-distutils-split-CC-env-var-before-passing-to-subproc.patch \
  0102-_testconsole.c-Fix-casing-path-sep.patch \
  0103-Return-consistent-architecture-markers-for-python-on.patch \
  0104-distutils-add-back-gcc_version.patch \
  0105-fix-mingw-cross-compiling-in-setup.py.patch \
  0106-handle-ncursesw-pkg-config-when-cross-compiling.patch \
  0107-mingw_smoketests-fix-_UCRT-condition.patch \
  0108-Modify-sys.winver-to-match-upstream.patch \
  0109-Change-user-site-packages-path-to-include-the-enviro.patch \
  0110-configure-Include-a-header-in-the-check-for-_beginth.patch \
  0111-configure.ac-Default-to-without-c-locale-coercion-on.patch \
  0112-Fix-failing-tests.patch \
  0113-distutils-add-build-root-to-libdirs-when-building-un.patch \
  0114-Don-t-change-os.sep-with-an-empty-MSYSTEM-env-var-no.patch \
  0115-def-VPATH-when-compiling-Python-sysmodule.c.patch \
  0116-Make-_Py_CheckPython3-extern.patch \
  0117-link-with-bcrypt.patch \
  0118-correctly-find-native-python.patch \
  0119-Add-extra-flags-for-_bootstrap_python.patch \
  0120-posixmodule-undefine-HAVE_OPENDIR.patch \
  0121-getpath.py-add-support-for-mingw.patch \
  0122-Don-t-build-_posixsubprocess-on-Windows.patch \
  0123-_ssl-link-with-ws2_32.patch \
  0124-Fix-building-_socket-module.patch \
  0125-Always-normalize-path-in-abspath.patch \
  0126-Include-winsock.h-when-checking-for-netdb-function.patch \
  0127-include-_multiprocessing-semaphore.c-on-win32.patch \
  0128-configure-build-mmap-module-on-win32.patch \
  0129-venv-creation-fixes.patch \
  0130-move-the-shutdown-function-where-winsock.h-is-includ.patch \
  0131-configure.ac-set-BUILDEXEEXT-and-EXEEXT.patch \
  0132-configure.ac-fix-building-some-test-modules.patch \
  0133-Don-t-convert-sysconfig.get_config_var-VPATH-to-an-a.patch \
  0134-Always-convert-to-before-passing-though-pathcch-func.patch \
  0135-Build-venvlauncher.exe-from-PC-launcher.c.patch \
  0136-getpath.py-fix-dirname.patch \
  0137-getpath-use-normpath-on-all-generated-paths.patch \
  0138-pathconfig-normpath-sys.path-0.patch \
  0139-smoketests-add-some-tests-for-sys-site-paths.patch \
  0140-Search-DLLs-only-on-paths-added-using-add_dll_direct.patch \
  0141-Allow-picking-up-include-lib-dirs-from-CFLAGS-LDFLAG.patch \
  0142-Build-and-install-libpython3.dll.patch \
  0143-setup.py-don-t-prepend-the-system-library-directorie.patch \
  0144-Port-GetPythonImport-to-mingw.patch \
  0145-LoadLibraryExW-make-sure-to-only-use-backslashes-for.patch \
  0146-Use-shared-instead-of-mdll.patch \
  0147-fixup-sysconfig-make-_sysconfigdata.py-relocatable.patch \
  0148-mingw_smoketests-add-a-test-to-check-if-sysconfig-re.patch \
  0149-Makefile-Add-a-dependency-on-LDLIBRARY-for-the-share.patch
 
  autoreconf -vfi
}

build() {
  declare -a _extra_config
  if check_option "debug" "n"; then
    _extra_config+=("--enable-optimizations")
    # Upstream defaults to -O3, so we can do too
    CFLAGS+=" -O3"
    # FIXME: https://github.com/msys2-contrib/cpython-mingw/issues/10
    # _extra_config+=("--with-lto")
  else
    CFLAGS+=" -O0 -ggdb"
    CXXFLAGS+=" -O0 -ggdb"
    _extra_config+=("--with-pydebug")
  fi

  case "${CARCH}" in
    i686)
      LDFLAGS+=" -Wl,--large-address-aware"
    ;;
  esac

  mkdir -p "${srcdir}/build-${MSYSTEM}" && cd "${srcdir}/build-${MSYSTEM}"

  ../Python-${pkgver}/configure \
    --prefix=${MINGW_PREFIX} \
    --host=${MINGW_CHOST} \
    --build=${MINGW_CHOST} \
    --enable-shared \
    --with-system-expat \
    --with-system-ffi \
    --with-system-libmpdec \
    --without-ensurepip \
    --enable-loadable-sqlite-extensions \
    --with-tzpath=${MINGW_PREFIX}/share/zoneinfo \
    "${_extra_config[@]}"

  make
}

check() {
  cd "${srcdir}/build-${MSYSTEM}"

  # Some basic tests to ensure nothing major or MSYS2 specific features are broken
  ./python.exe "../Python-${pkgver}/mingw_smoketests.py"
  MSYSTEM= ./python.exe "../Python-${pkgver}/mingw_smoketests.py"
}

package() {
  cd "${srcdir}/build-${MSYSTEM}"

  make -j1 install DESTDIR="${pkgdir}"

  # gdb pretty printers for debugging Python itself; to use:
  # python
  # sys.path.append('C:/msys64/mingw64/share/gdb/python3')
  # import python_gdb
  # reload(python_gdb)
  # end
  if [[ "${_primary_python}" == "yes" ]]; then
    [[ -d "${pkgdir}${MINGW_PREFIX}"/share/gdb/python3/ ]] || mkdir -p "${pkgdir}${MINGW_PREFIX}"/share/gdb/python3/
    cp -f python.exe-gdb.py "${pkgdir}${MINGW_PREFIX}"/share/gdb/python3/python_gdb.py
  fi

  # some useful "stuff"
  install -dm755 "${pkgdir}${MINGW_PREFIX}"/lib/python${_pybasever}/Tools/{i18n,scripts}
  install -m755 "${srcdir}/Python-${pkgver}"/Tools/i18n/{msgfmt,pygettext}.py "${pkgdir}${MINGW_PREFIX}"/lib/python${_pybasever}/Tools/i18n/
  install -m755 "${srcdir}/Python-${pkgver}"/Tools/scripts/{README,*py} "${pkgdir}${MINGW_PREFIX}"/lib/python${_pybasever}/Tools/scripts/

  # fixup shebangs
  for fscripts in 2to3 2to3-${_pybasever} idle3 idle${_pybasever} pydoc3 pydoc${_pybasever}; do
    sed -e '1 { s|^#!.*$|#!/usr/bin/env python'"${_pybasever}"'.exe| }' -i "${pkgdir}${MINGW_PREFIX}"/bin/${fscripts}
  done

  # default aliases for all scripts/binaries
  if [[ "${_primary_python}" == "yes" ]]; then
    # Default names are aliases for Python now
    cp "${pkgdir}${MINGW_PREFIX}"/bin/python3.exe "${pkgdir}${MINGW_PREFIX}"/bin/python.exe
    cp "${pkgdir}${MINGW_PREFIX}"/bin/python3w.exe "${pkgdir}${MINGW_PREFIX}"/bin/pythonw.exe
    cp "${pkgdir}${MINGW_PREFIX}"/bin/python3-config "${pkgdir}${MINGW_PREFIX}"/bin/python-config
    cp "${pkgdir}${MINGW_PREFIX}"/bin/idle3 "${pkgdir}${MINGW_PREFIX}"/bin/idle
    cp "${pkgdir}${MINGW_PREFIX}"/bin/pydoc3 "${pkgdir}${MINGW_PREFIX}"/bin/pydoc
  fi

  # delete anything that could conflict with the primary Python
  if [[ "${_primary_python}" != "yes" ]]; then
    rm "${pkgdir}${MINGW_PREFIX}"/bin/python3.exe
    rm "${pkgdir}${MINGW_PREFIX}"/bin/python3w.exe
    rm "${pkgdir}${MINGW_PREFIX}"/bin/python3-config
    rm "${pkgdir}${MINGW_PREFIX}"/bin/idle3
    rm "${pkgdir}${MINGW_PREFIX}"/bin/pydoc3
    rm "${pkgdir}${MINGW_PREFIX}"/bin/2to3
    rm "${pkgdir}${MINGW_PREFIX}"/lib/pkgconfig/python3-embed.pc
    rm "${pkgdir}${MINGW_PREFIX}"/lib/pkgconfig/python3.pc
    rm "${pkgdir}${MINGW_PREFIX}"/share/man/man1/python3.1
  fi
}

sha256sums=('0fab78fa7f133f4f38210c6260d90d7c0d5c7198446419ce057ec7ac2e6f5f38'
            'e8bc6992aab35878f1b797527801516cf20fde18907ab5f0f6035e9e2d98aa56'
            '7b2974bc0267869a74c9d90aa9b17d70053c50d7ada1ed74d88764773c49581b'
            '3ec9d31277c4c106b59d8f7f4d7e31df7b88732f22aff4cc2db139ee3dbd1518'
            '749e625b35d0fde9a2a57254ee4234d1e32429c58f98398318eb0ecb9bd4e27f'
            'a15912e751dd102ea7449a78d194886f55539f4556bb902221ae9e5fcd123200'
            '7626edeadaf44f1af787cd5e476b0dcfcca0ef370c5590bc6798aaa46e5534b1'
            '2f9739488e8421ad03c286a579339c7cc252902753c8fddef4894ffbd26d4e88'
            '5a344d6af569ce480dcfd26e29a3abf731c8daa135fb6224aa8c1b556c2ca666'
            '20e5079cc15042ceb675661bbaa88fa2af199ba3a8e6d806cb43d619729209a8'
            'e3d1e970c00e278fedc430e34452d35607a449a14cba6f5c507d14c2eb7e251c'
            'f7cf45c9aaea47843f52e9dea79570d7a401917d75ba0f6ed9b3bcbab670c19d'
            '3f5fe5c86aafe08fbacba7820ab24657c3e399f272a3835fb4199ecceae40b33'
            'a8d2670e592b36456b74b414f5cd96e744108739f12bda315dedea947ecd686e'
            'e8d0026e27e8d1bae33ab8a3a714f1110a783055b091fdb2aba936a735891806'
            'cec1f89ac7746d8ca19b0f471a1ce80da233b4e76035a29f4babfc16717b22f1'
            '580d7640d47eb1c34b67c64f7fc44998dda58a3057ca4abad2dbfd31d92728c2'
            'c8fe0d5ba40f3d9822effad3fe1df807860d983e520da7aa2923a2f5ffb037cf'
            '5dcc68538af4feeb8acaf974e644269fb769d5135786923eab12bb918473fdc6'
            '022901885c408fbe7c7ddc2449245134d9dd336dbfe1146e6bb51d5ccefcb894'
            '40b4ec870108ae42e84fb019c287be5a425f8d02049c1927e210e2c4b640869d'
            '28b61b54de5bd733ba36f2080b348780d579c9f0ab194084d1fc8370f17bc49c'
            '9df015ee7206d2c3553bc3cd625fba2c0ab1458e10b906155755050bc2ba2936'
            '79d141c06e4367b074e7776d9cb2ddbb0ff1e17b791b0158f15ffe9f63b401bb'
            '90d4787e9e955377b4865dfcc32f743a95aabca5d1572091784c7a84286f9d58'
            '5a7b1e0698f09830c5baf6f057b28830e40eec0666ca17e2db318ef49711ea6b'
            'cedf77de131718d73b35e7a029045b213cc582a6b83de564e494bf8297fc4677'
            '656ecf804abc172bc95b9505a9842ba7d4188d83fcee909a910750a6ea70ad5f'
            '10a428759782415059ac10af28bed39aa8ecc9a3e54f7cecf842356d900cc2f2'
            'da7e278d3046c2ce4eccc3f2ecec4cd40f820ee7a9d5e52dab3a319abeaeefaf'
            'f54db4337e12d6034fa2901bcdd0a56ff8c2cc8ad16c91f3990fd5007c884be1'
            '89321d7c5bb6f2dae174454f3ae547767887acb29c912fb6ec75bc7a5c1eb8f5'
            'ebc7f46403d5fbd809fadb00b0773dfa86b455040f6e942eb6c870b3c3542a54'
            '5c6bd289c9b9b4696f5f4ec2d6f6f959a85c97ac909bb468afe85a3cb8af57b9'
            '6e12228bbc91b7f8cf4d05b52d0235571a22ee86fa6aaaac2ac262ba8c0a7dc2'
            '22d9247ad06941e9c29ba54e65dcf7c269d86e4b41d5366b133a696d99dd9d32'
            '9ef4a44c8833ec4c227e2d5111983eafccdfb0ed4507e6f56d08fee0b2e3cf1b'
            'b5361b0d210b77e9a0b100832d648aaa04a2448e3f03dc45ec26b5231037c45c'
            '43a2ae7ae7a6b3998c03426dcc29ea534669c5147e57e803be066aba2a6d92b4'
            '9854816e49b41e0c002fd6e8b27245ed831bbdccf52483aace2686c305450deb'
            '8d1d60ebdc020b09cbfbfacb3f76f6412776b6016884e4019c00a362137d662c'
            'c0594353fa71213ae8e1c08b0bdbb1c4c192ab9a9136af73fcef7df53012269d'
            'c5920b2e25216a94a0e5aed6852df27ef279fc57cb8731af860154c2e1d384f9'
            '15744a4c4ebeb16e707630a88bac29cb18e73be026842ae9da6b110e06b75cdb'
            '662c196bceb17ba43c7ee4dafd22550b68d15d9c6956fa86529220aa0ca9204b'
            '6741f45eafb7ed312e7314c327962cdc9b473e9a21b9825d84eb2382220940fd'
            'c7cfa4f78da77a57f6ad6777ccbbe70589329c2c2637f246cbdd33667e2fb966'
            '17f48b69aadc148ebe412453952ebc43eef4f21dfcbd634423efaa6d686edfc2'
            'd7b9a9897baedff1277d7abdf7b50982b98bf552d512372813f299a26e166c73'
            'a34641289b63e11fc002e50824c3eb42c7bd05596c3753250332fcaf99acc6b0'
            'f4b503d18f5d41f0f1e493f815cac35cb9ca3806ce850360486937a3b129300c'
            '51b80db0ea5cd2ead31bfa40d5e16716da33485312800cff95eba8bc60a9ba77'
            '773690f96a029ccbfcdad83309aacb868cd4c1b05aa91020429b9e90a2fb1ec1'
            'e0243be5a7af2af69d76defe25373ed34ceb20890bcca0ac5e523103780a3202'
            '533b299bc186a6b67f2010067c2c3ab1e9936514687e0f09e98407de94f491af'
            'da918b90878486e7532f18397224166a7472f17208af324eb5da1691e1d6fe80'
            'b6154b3d6dcf3d020c8d37041dd7f7b3d047998855b2f0bcd0a5efb896e5cf40'
            '9ad8fb3141c09415b3b8a73959d3cf3217b38dbe3042cc0a88fbacad98fa4a21'
            'f691ec405f17f56fb46130285dae6fca114dd0d8652035d369a1a83d3595016d'
            'fca6186cdb75e7b2bd3147b48f4e98a4f2a3ff84afbeb027012bfbfba4bb75e5'
            'efe81b53c9e94ad85dba3f031057152f6b66eff225583721bb1eb08bf30dcb54'
            '0f9f090c7eb6f52a038f66e46b7dd5714fc7bedd3a9a666cb31fa78f2529a3ec'
            '62347e05e28f880e918a591d8fdd41ee40d0cbe625543e661186ee6741bacd76'
            '1aaab982b6c81663e2523abbbbecf74ed52d0251ad83ca51aeac367760726c04'
            '5c3032b8cb8262e6c72fe9f0d4294b0d3c7cc9d831b995817f20e3bbba56faeb'
            '2af41b02725996b85673b8b8d173bd210d901500743ca36a7a6249059c88bd9d'
            'd05965fd9f49b79d96662b720b0eb2674662d959702fe54fb15036996f5a120e'
            '9dc3bd39d095b0fded17a3f6b1bb9c87848147602b8c825684332c8d9cc785d2'
            '587ac14d5c20ad884ed6de2902a22e72d318a4a880893d3d24c2703e4d19b55a'
            'fa53ede507406da4583ed2f2872b01a5485bdfd9a82b8691048bba0b2b46a1a9'
            '1fbfaeff99b3cab7f5c542937f4f6d27f945bf1e942a28cdc68de9599e3c21e1'
            '408beae9fc02582bbe4d7c7808c85d6f07457913f7428a2dcc4c63c7f326938c'
            '93e3daea18b692f834f5a37153f2215fbbb10f424ae492f0ba716efa042fdbe5'
            '8a62688ce2768afab24ba9e8448d827c7849a20f95a28e29a20d3b9bef9e6ef8'
            '70cd9adc0780d6f0b0d4dd36ebe5047a67ebaede0609febd6e893db3403b90cb'
            '7a80ad20960f53afe660face1f59f6ac6c2eb3d2a50d34a094e738ecf865675f'
            '289d8f6c3be45941aa7829e1c91c241989dafebca59217f8d329651918a94dc8'
            '60fe2be6b972692693efd1f8f8da61c559fb8fc0be7e614dd044b343303b1584'
            '504486f7ca825058a90e537ffc9bf6421e963b0200cbc4335703bc37dd208315'
            'a5ae2a62070ddd5d2ef2acb2d5e875dd2b4a1b7bb6c25ae7625ec8385f43306d'
            'f766c1490fa87631b375ba2cced971e1262653697c327f5482f8caa4fe53f758'
            'c5df331dd65ac55a33b50e7545646e3130d67d573262e7f7d49402c1a118cd2d'
            '4215a73e72ea592adc9b78e2b430e36a72537290f27f9d86af6aa938786d4068'
            'd6f60a4414a32b933adc47008030eed4dbb9e41192306da4f83c432e2ae23cab'
            'ef013c687900c6c8e6b04a83a92880b4bc6a457549f2fb6a554585650c66f233'
            'e612f66727c3fa9e13f02943b7ccde40544dc12c306e7884c0d46cc06885fdc3'
            'b4de9ff827c04b509cd8113714ef4dd8a1f3e801c635c497fa8606eaf2531d8d'
            '429e2a59ee184362b48895d43caa8bfdc9023887fcfa44f0e2ee6f273810b3ff'
            'f418af01bca5b99497a3dc64381356b7c80e82c14aa5d256f686a16296309dbe'
            '1ac43e5516c9c0288aadf019d375f44831ca0c8c8e2008ba964264c82cdc0806'
            '08a93886e5862b91e37a1d0e45b68e6307e7618bd1f037da77c7e8f1b3caaf03'
            'c4c3abc2c318bf3bf7b241590841a5932fc3ec0bd7b05c3b65c81afa50d10097'
            'f2f9baecf73265948f9bd3d71fabfcd7c93fa1529eea7f743004ae97f6e8b4a1'
            'ad640f295a3304f1411d355dd05014b818c43f467e56f655fd28b806f4884d10'
            '92bb17c6ba4e19feac8a57c08f84e051701b73822d9265edc26cef4c500b9a2c'
            'd4bc24e178468aa8bc8794137411d26a5f8a40ea4ca723c5910c4f950fd71863'
            '5b3ab4782be568da71b712ac4c6d991598b944598ced5ca47c061ec88230b101'
            '46b671aa8b4aedffd73bd228314b59dd087a5379569d133e414752556b3388c4'
            'eba7a79a3631e537f4b56fe300408b73c422c1f1ae4cf4f76176ad478d2d1287'
            'e255e0aaaca0fcb24878457c428162169a3ffdb8508da0e4ccc673ce127121b4'
            'efb2dc7d4b2b44d91a68dd69834a23e8af4748eb02e198e4ab35a875ab0990a4'
            '1adce124af9599f2eb7a27233c4334b41801676ff683b1ae18fd92b54722d790'
            '326f04df28bff61a8de72d7a4ebcf2b5d69d65be636675d42e99395a64647915'
            '8bd736d1f0b0cc60878368e28017aeef5e5b6c2c264f757c8fbacd77ae904402'
            'a2b5b360c5b0b61b67d1b2fd41a1a219e62c40944dc27a70c0cbb18905c92cdc'
            '86f7b14e648ce697bdc89affa28c3e2a76e7aabc7618d73288d65193d86c4f6d'
            'c47c176097432aa2d40fc2a7fce32a49f35c73ec43e769c35e95e8ea5ed51d43'
            '7b2fd2ce5cd0ce36362c591f1c7cfb65e3433a3044aa95999016607d90f09bfb'
            '5477cfe4e858af59172a5c35558d224b749af9844c4ea938e1a76420fe4586c6'
            '8107b037e5db3bbf5f8a336f5feddbce2c26f0c3889065fbacf453f4873ab771'
            'be188de10f978c8b586af001462bfbac9ce7a17be27d8095d47d48821a92f90c'
            '2508578c0da7cbd4fc2a703839f9641b4b81b6af187adb86d1581354d6a07102'
            '011e857b4cc004dc6c5cdfcfe3e4203a4d61d4deccc87e3078ff3d16fdf07f39'
            '400371c439e2d756c243c188d0030afde74be8f03797ebf684ead0656237fc66'
            '350b953479cc96b30c053213683fa55b802067b9277fabeada156f976db0a122'
            '55c907626983dce965470f8db075eaf3864ec488778085391aea92e25da55d1c'
            '22853539fb102784227d7ffe6da78350f767c05c74d841749b9d75dd3c7878d2'
            '8ab3e796b372b4c9468544e33de01bc1c07b5c90c6e3181b5782cfbc0663ad0b'
            '64d11336f3c39a9d94595ee562feb8edbb9a5db7bc6a62e60c098b57c0a90da4'
            'c2748c494ccce93a93a2e11b1ddc66d5c380bcf790e4e3cb43f67a05189d2f5a'
            '3ef569264112bb0421a22b0730eb38bcb1abcab92481efe2e3316601bcafe18b'
            '2bc5f8b25b5413894fdfe9f866c366f37bd3afb230e4854e3f23829ccf822f64'
            '85077af45268749ed4c64b32246d4c4b5c16c14e3cb22bbf68fe58fabaa6cfcb'
            '868742b69069b033681758deeb436bbb01d0785f3825db6dbb0d56e02d258837'
            'a5f79661a71bf1a51723b601f91d64c67826242b5ed27182714fbe6fe4990e0a'
            '85753034e853461e7479f42195724f45689d198fca6aba9ea04c886f536018cb'
            '19e62b89159153cb8e44d4a9cc68c02e2cd33adb6b9c8b8813ee525fc3bd895e'
            'a176ebfea20cee03a88a9c17017253b08b5bc7f1d33048b438fc22f4d85c244d'
            '4755bb696646b799969798b260b8a91d85dd8402aa0c2a0eb4529a5bc8afcf65'
            'd02b34b0107f35caaaa1a1eca8d3777998ec47fadcbc00f8f5fefb94bbcec9a9'
            '8e1e9946da23eb99cb72c927ff9b1fecae473a54848abcc20f9e3da5d8527e5e'
            'cd67e82fa30abb6848c0a58ad288ce7ef7a6381b52eaa1b58988ad2afa27ad34'
            'a71f9b7d01e9506931ff0b097471d9b4680c9c6fefccbab6360fc10dbcd097b5'
            'b9b110b0d5efc40c6aeb08f9ded20b994b3b57829871dab90dc08cdf0ac430c2'
            'dfe654d4f62e3447c0239baa6a385ae1b5695af158afa4e66c562232444122ca'
            '99042e2d17e106294c6d1e99464c55f0ade97a014bb7e927bd4f00b5f7809ace'
            '04c3a756db3607eab8d162f26dd5cd2d792dd5e5bb47b28675b7e33f210ca28e'
            '29feaf8a668bf5f367387749d0b389e13136122f961a169dc9b8caf55ce5d1d5'
            '8bf1adde50598e17928d9cce3aa45d5dec794171bb0eb704e9c2435a018bb94d'
            '5346c72c92d4346e17d7191a29523f14c7010169444368d4d7539f76d9a0ffda'
            '764ca566db0d7f7c75f85556dd45327363ed0687070c5a14fddfa08bb6b4499d'
            '67bad10df0d297a855a273ae62a2210328b7e0a00b64ed63521c399a4adb35c9'
            '8cbb64fbaac528fc563a8d74109bc22668a9d10c349c8fecf0378dc3cdb51d2a'
            'a237465765f6019c480a8facac1432c243cbacbe0dcc7ccd36545b62b8afb726'
            '06704b6f161aa2607b1d3f7183fbc9f57e7b3f1b3a1ad97abcf7ef007c952029'
            'ab6d51169505a411c5a08d8f836b2bc96952f1bcc0ba72da121f1f174775138d'
            '744b03578179560f336ac589d062f5fe2080e1f05f461fd4d256be0fa721e3d9'
            '21852e0a64c8867f709de718cf56a6a5b780b4c802c0684ddfcdacff366c1088'
            '36a5270729f50590143ab21ec9205278f38c06278ce0bb66a4210c3c9ad58f28'
            '18961bdb9bb6267cb8f0e9dc4332f1252ca5cb3aa90dab37a6ff173b8f4d5957')
